<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV to Excel - Custom Naming</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 40px; background-color: #f0f2f5; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h2 { color: #1a73e8; text-align: center; margin-bottom: 5px; }
        p.subtitle { text-align: center; color: #5f6368; margin-bottom: 30px; }
        
        #drop-zone {
            border: 3px dashed #1a73e8;
            padding: 40px;
            text-align: center;
            border-radius: 10px;
            background-color: #f8fbff;
            color: #1a73e8;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        #drop-zone.dragover { background-color: #e8f0fe; border-color: #0d47a1; transform: scale(1.01); }
        
        button { background-color: #188038; color: white; border: none; padding: 12px 25px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 20px; }
        button:hover { background-color: #13652b; }
        
        #preview-container { margin-top: 30px; display: none; }
        .table-wrapper { overflow-x: auto; max-height: 400px; border: 1px solid #dadce0; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { background-color: #1a73e8; color: white; position: sticky; top: 0; padding: 10px; z-index: 10; }
        td { border: 1px solid #dadce0; padding: 8px; text-align: left; white-space: nowrap; }
        tr:nth-child(even) { background-color: #f8f9fa; }
        
        .status-bar { margin-top: 15px; padding: 10px; border-radius: 5px; display: none; background: #e6f4ea; color: #137333; font-weight: 500; }
        .info-box { background: #fff3e0; border-left: 5px solid #ff9800; padding: 10px; margin-top: 10px; font-size: 13px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Convert CSV ke Excel</h2>
    <p class="subtitle">Otomasi pengubah file csv ke excel dengan Penamaan Otomatis</p>

    <div id="drop-zone">
        <strong style="font-size: 1.2em;">Tarik & Lepaskan File CSV di Sini</strong><br>
        <span>atau klik untuk memilih file</span>
        <input type="file" id="fileInput" accept=".csv" style="display:none">
    </div>

    <div class="info-box">
        <strong>Fitur Otomatis:</strong><br>
        - Kolom <b>ALAMAT</b> dipisah menjadi kolom RT & RW .<br>
    </div>

    <div id="status" class="status-bar"></div>
    
    <div id="preview-container">
        <h3>Preview Data (10 Baris)</h3>
        <div class="table-wrapper">
            <table id="previewTable"></table>
        </div>
        <center><button id="downloadBtn">Download Excel (.xlsx)</button></center>
    </div>
</div>

<script>
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('fileInput');
    const statusDiv = document.getElementById('status');
    let csvData = [];
    let generatedFileName = "data_export";

    dropZone.onclick = () => fileInput.click();
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
    dropZone.ondragleave = () => dropZone.classList.remove('dragover');
    dropZone.ondrop = (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) processFile(e.dataTransfer.files[0]);
    };
    fileInput.onchange = (e) => { if (e.target.files.length > 0) processFile(e.target.files[0]); };

    function processFile(file) {
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            dynamicTyping: false,
            complete: function(results) {
                if (results.data.length > 0) {
                    // AMBIL DATA UNTUK NAMA FILE (dari baris pertama)
                    const firstRow = results.data[0];
                    const kab = (firstRow["KAB_NAME"] || "KAB").replace(/\s+/g, '_');
                    const kec = (firstRow["KEC_NAME"] || "KEC").replace(/\s+/g, '_');
                    const bansos = (firstRow["BANSOS"] || "BANSOS").replace(/\s+/g, '_');
                    
                    // Set nama file baru
                    generatedFileName = `${kab}_${kec}_${bansos}`.toUpperCase();
                }

                // PROSES TRANSFORMASI DATA
                csvData = results.data.map(row => {
                    let fullAlamat = row["ALAMAT"] || "";
                    let rtVal = "";
                    let rwVal = "";
                    let cleanAlamat = fullAlamat;

                    const rtMatch = fullAlamat.match(/RT:(\d+)/i);
                    const rwMatch = fullAlamat.match(/RW:(\d+)/i);

                    if (rtMatch) rtVal = rtMatch[1].padStart(3, '0');
                    if (rwMatch) rwVal = rwMatch[1].padStart(3, '0');

                    if (fullAlamat.toUpperCase().includes("RT:")) {
                        cleanAlamat = fullAlamat.split(/RT:/i)[0].trim();
                    }

                    const { ALAMAT, ...rest } = row;
                    return {
                        ...rest,
                        "ALAMAT": cleanAlamat,
                        "RT": rtVal,
                        "RW": rwVal
                    };
                });

                statusDiv.innerText = `âœ“ Berhasil memproses ${csvData.length} data. Nama file disiapkan: ${generatedFileName}.xlsx`;
                statusDiv.style.display = "block";
                renderPreview(csvData.slice(0, 10));
                document.getElementById('preview-container').style.display = 'block';
            }
        });
    }

    function renderPreview(data) {
        const table = document.getElementById('previewTable');
        if (data.length === 0) return;
        const headers = Object.keys(data[0]);
        table.innerHTML = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join("")}</tr></thead>` +
                         `<tbody>${data.map(row => `<tr>${headers.map(h => `<td>${row[h] || ''}</td>`).join("")}</tr>`).join("")}</tbody>`;
    }

    document.getElementById('downloadBtn').onclick = function() {
        if (csvData.length === 0) return;
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(csvData);
        const headers = Object.keys(csvData[0]);
        const wscols = [];

        headers.forEach((key, colIndex) => {
            let maxLen = key.length;
            const isTextCol = key.toUpperCase().includes("NIK") || 
                              key.toUpperCase().includes("NOKK") || 
                              key.toUpperCase().includes("KK") ||
                              key === "RT" || key === "RW";

            csvData.forEach((row, rowIndex) => {
                let cellValue = row[key] ? row[key].toString() : "";
                if (cellValue.length > maxLen) maxLen = cellValue.length;

                if (isTextCol) {
                    const cellAddress = XLSX.utils.encode_cell({r: rowIndex + 1, c: colIndex});
                    if (ws[cellAddress]) {
                        ws[cellAddress].t = 's';
                        ws[cellAddress].z = '@';
                    }
                }
            });
            wscols.push({ wch: maxLen + 2 });
        });

        ws['!cols'] = wscols; 
        XLSX.utils.book_append_sheet(wb, ws, "Data");
        XLSX.writeFile(wb, `${generatedFileName}.xlsx`);
    };
</script>

</body>
</html>
